{{define "pages/home.html"}}
{{template "head" .}}
<h1 class="title is-4">Dashboard</h1>
<p class="subtitle is-6">Profile: {{if .profile}}{{.profile.Username}}{{else}}unknown{{end}}</p>

<!-- Quick Actions Section -->
<div class="box mb-5">
  <h2 class="title is-5 mb-4">Quick Actions</h2>
  <div class="field is-grouped">
    <p class="control">
      <form id="import-form" method="post" action="/import" style="display: inline;">
        <button class="button is-primary" type="submit">Import latest games</button>
      </form>
    </p>
    <p class="control">
      <form id="resume-form" method="post" action="/resume-analysis" style="display: inline;">
        <button class="button is-link" type="submit">Resume analysis</button>
      </form>
    </p>
    <p class="control">
      <form id="stop-form" method="post" action="/stop-analysis" style="display: inline;">
        <button class="button is-danger" type="submit">Stop analysis</button>
      </form>
    </p>
    <p class="control">
      <form method="POST" action="/analytics/refresh" style="display: inline;">
        <input type="hidden" name="redirect" value="/">
        <button type="submit" class="button is-light">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.425A6 6 0 1 1 8 2v1z"/>
              <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
            </svg>
          </span>
          <span>Refresh Stats</span>
        </button>
      </form>
    </p>
  </div>
</div>

<!-- Analysis Progress Section -->
<div id="analysis-progress" class="box mb-5" style="display: none;">
  <h2 class="title is-5 mb-4">Analysis Progress</h2>
  <div id="progress-stats" class="mb-4">
    <div class="columns">
      <div class="column">
        <p class="heading">Pending</p>
        <p class="title is-5" id="stat-pending">-</p>
      </div>
      <div class="column">
        <p class="heading">Processing</p>
        <p class="title is-5" id="stat-processing">-</p>
      </div>
      <div class="column">
        <p class="heading">Completed</p>
        <p class="title is-5" id="stat-completed">-</p>
      </div>
      <div class="column">
        <p class="heading">Estimated Time</p>
        <p class="title is-5" id="stat-estimated">-</p>
      </div>
    </div>
  </div>
  <progress id="progress-bar" class="progress is-primary" value="0" max="100">0%</progress>
  <p class="help mt-2" id="progress-text">Calculating progress...</p>
</div>

<!-- Quick Stats Section -->
{{if .total_games}}
<div class="columns mb-5">
  <div class="column">
    <div class="box has-text-centered">
      <p class="heading">Total Games</p>
      <p class="title is-4">{{.total_games}}</p>
    </div>
  </div>
  <div class="column">
    <div class="box has-text-centered">
      <p class="heading">Pending Analysis</p>
      <p class="title is-4">{{.pending_count}}</p>
    </div>
  </div>
  {{if .due_flashcards_count}}
  <div class="column">
    <div class="box has-text-centered">
      <p class="heading">Due Flashcards</p>
      <p class="title is-4">{{.due_flashcards_count}}</p>
    </div>
  </div>
  {{end}}
</div>
{{end}}

<!-- Feature Cards Section -->
<h2 class="title is-5 mb-4">Features</h2>
<div class="columns">
  <div class="column">
    <div class="card">
      <div class="card-content">
        <h3 class="title is-5">Games</h3>
        <p class="subtitle is-6 mb-4">Browse and filter your chess games</p>
        <p class="mb-4">View all your imported games, filter by result, time control, or opening. Analyze individual games and review positions.</p>
        {{if .total_games}}
        <p class="mb-4"><strong>{{.total_games}}</strong> games imported</p>
        {{end}}
        <a href="/games" class="button is-link">View Games</a>
      </div>
    </div>
  </div>

  <div class="column">
    <div class="card">
      <div class="card-content">
        <h3 class="title is-5">Analytics</h3>
        <p class="subtitle is-6 mb-4">View opening stats, opponent records, and performance metrics</p>
        <p class="mb-4">Explore your opening performance, head-to-head records against opponents, time control statistics, and detailed performance trends.</p>
        <a href="/analytics" class="button is-link">View Analytics</a>
      </div>
    </div>
  </div>

  <div class="column">
    <div class="card">
      <div class="card-content">
        <h3 class="title is-5">Flashcards</h3>
        <p class="subtitle is-6 mb-4">Review positions from your mistakes and blunders</p>
        <p class="mb-4">Practice with spaced repetition flashcards created from your blunders and mistakes. Improve your chess by reviewing critical positions.</p>
        {{if .due_flashcards_count}}
        <p class="mb-4"><strong>{{.due_flashcards_count}}</strong> flashcards due for review</p>
        {{end}}
        <a href="/flashcards" class="button is-link">View Flashcards</a>
      </div>
    </div>
  </div>
</div>

<p class="is-size-7 has-text-grey mt-5">
  Need a different account? Use <a href="/profiles">Switch profile</a>.
</p>

<script>
// #region agent log
(function() {
  var form = document.getElementById('import-form');
  var logData = function(msg, data) {
    fetch('http://127.0.0.1:7243/ingest/1f6c8cec-101d-462a-9c14-fbdf343d2a72',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'home.html:script',message:msg,data:data,timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H1-H3'})}).catch(function(){});
  };
  logData('script loaded', {formExists: !!form, formAction: form ? form.action : null, formMethod: form ? form.method : null});
  if (form) {
    form.addEventListener('submit', function(e) {
      logData('form submit event', {defaultPrevented: e.defaultPrevented});
    });
    var btn = form.querySelector('button[type="submit"]');
    if (btn) {
      btn.addEventListener('click', function(e) {
        logData('button clicked', {target: e.target.tagName, formId: form.id});
      });
    }
  }
})();
// #endregion

// Auto-refresh analysis status every 5 seconds
(function() {
  function updateAnalysisStatus() {
    fetch('/api/analysis/status')
      .then(function(r) {
        if (!r.ok) {
          throw new Error('Failed to fetch analysis status');
        }
        return r.json();
      })
      .then(function(data) {
        document.getElementById('stat-pending').textContent = data.pending || 0;
        document.getElementById('stat-processing').textContent = data.processing || 0;
        document.getElementById('stat-completed').textContent = data.completed || 0;
        document.getElementById('stat-estimated').textContent = data.estimated_time || 'N/A';
        
        var total = (data.pending || 0) + (data.processing || 0) + (data.completed || 0);
        var progress = total > 0 ? ((data.completed || 0) / total) * 100 : 0;
        var progressBar = document.getElementById('progress-bar');
        progressBar.value = progress;
        progressBar.textContent = Math.round(progress) + '%';
        
        var queueText = (data.queue_size || 0) + ' in queue';
        document.getElementById('progress-text').textContent = 
          (data.completed || 0) + ' of ' + total + ' games analyzed (' + queueText + ')';
        
        // Show progress section if there are pending/processing games
        var progressSection = document.getElementById('analysis-progress');
        if ((data.pending || 0) > 0 || (data.processing || 0) > 0) {
          progressSection.style.display = 'block';
        } else {
          progressSection.style.display = 'none';
        }
      })
      .catch(function(err) {
        console.error('Failed to fetch analysis status:', err);
      });
  }
  
  // Update immediately and then every 5 seconds
  updateAnalysisStatus();
  setInterval(updateAnalysisStatus, 5000);
})();
</script>
{{template "foot" .}}
{{end}}
